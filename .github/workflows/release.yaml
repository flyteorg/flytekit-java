name: flytekit-java release

on:
  release:
    types: [created]

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v1
      with:
        fetch-depth: "0"
    - name: Cache local Maven repository
      uses: actions/cache@v2
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-maven-prepare-release-${{ hashFiles('pom.xml') }}
    - name: Set up JDK 11
      uses: actions/setup-java@v1
      with:
        java-version: 11.0
        distribution: 'adopt'
    - name: Log in to Docker Hub
      uses: docker/login-action@v1
      with:
        registry: ghcr.io
        username: ${{ secrets.FLYTE_BOT_USERNAME }}
        password: ${{ secrets.FLYTE_BOT_PAT }}
    - uses: s4u/maven-settings-action@v2.2.0
      with:
        servers: |
            [{
              "id": "flytekit-java-release",
              "username": "${{ secrets.SONATYPE_USERNAME }}",
              "password": "${{ secrets.SONATYPE_PASSWORD }}"
            }]
    - name: Release with maven
      env:
        RELEASE_REPOSITORY_URL: "https://s01.oss.sonatype.org/"
        SNAPSHOTS_REPOSITORY_URL: "https://s01.oss.sonatype.org/"
      run: mvn deploy release:prepare -DpreparationGoals=clean -DskipTests=true -Dghcr.io/flyteorg/jflyte  -Ddockerfile.push